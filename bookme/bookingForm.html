<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
      }

      h1 {
        color: #333;
        text-align: center;
      }

      form {
        max-width: 400px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      input[type="text"],
      input[type="email"],
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        margin-bottom: 15px;
      }

      button[type="submit"] {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
      }

      button[type="submit"]:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <h1>Booking Form</h1>
    <form id="bookingForm">
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required>
      
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>
      
      <label for="timeSlot">Available Time Slots:</label>
      <select id="timeSlot" name="timeSlot" required></select>
      
      <button type="submit">Book Appointment</button>
    </form>
    
    <button onclick="testCreateCalendarEvent()">Test Create Calendar Event</button>
    
    <script>
      function handleError(error) {
        console.error('Error:', error);
        alert(`Error: ${error}`);
      }

      console.log('HTML file loaded');

      async function getAvailableSlots() {
        try {
          const slotsString = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getAvailableSlots();
          });
          console.log('Slots string received:', slotsString);
          const slots = JSON.parse(slotsString);
          console.log('Slots parsed:', slots);
          displayAvailableSlots(slots);
        } catch (error) {
          console.error('Error:', error);
          handleError(error);
        }
      }

      function displayAvailableSlots(slots) {
        console.log('In displayAvailableSlots', slots);
        let slotList = document.getElementById('timeSlot');
        slotList.innerHTML = ''; // Clear previous options
        slots.forEach(slot => {
          const startTime = formatTime(slot.start);
          const endTime = formatTime(slot.end);
          const slotText = `${startTime} - ${endTime}`;
          const option = document.createElement('option');
          option.value = `${slot.start},${slot.end}`;
          option.textContent = slotText;
          slotList.appendChild(option);
        });
      }

      function formatTime(date) {
        return new Date(date).toLocaleString('en-US', {
          hour: 'numeric',
          minute: 'numeric',
          hour12: true
        });
      }

      // Fetch available slots when the page loads
      window.onload = getAvailableSlots;

      // Handle form submission
      const bookingForm = document.getElementById('bookingForm');
      bookingForm.addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent the default form submission

        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const selectedSlot = document.getElementById('timeSlot').value.split(',');
        const startTime = new Date(selectedSlot[0]);
        const endTime = new Date(selectedSlot[1]);

        console.log('Form submitted with:', { name, email, startTime, endTime });

        try {
          const resultString = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .createCalendarEvent(name, email, startTime, endTime);
          });

          console.log('Calendar event creation result string:', resultString);

          const result = JSON.parse(resultString);

          console.log('Calendar event creation result:', result);

          if (result) {
            alert('Appointment booked successfully!');
            bookingForm.reset(); // Reset the form
          } else {
            alert('Failed to book the appointment. Please try again.');
          }
        } catch (error) {
          console.error('Error:', error);
          handleError(error);
        }
      });

      // Test function
      async function testCreateCalendarEvent() {
        const name = 'Test User';
        const email = 'test@example.com';
        const startTime = new Date(2024, 4, 27, 19, 0, 0); // May 27, 2024, 7:00 PM
        const endTime = new Date(2024, 4, 27, 20, 0, 0); // May 27, 2024, 8:00 PM

        const result = await google.script.run.createCalendarEvent(name, email, startTime, endTime);
        console.log('Test result:', result);

        if (result) {
          console.log('Event ID:', result.id);
          console.log('Event Title:', result.title);
          console.log('Event Start Time:', result.startTime);
          console.log('Event End Time:', result.endTime);
          console.log('Event Description:', result.description);
        } else {
          console.log('Failed to create event');
        }
      }
    </script>
  </body>
</html>
