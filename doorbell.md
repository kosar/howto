# Retrofit Doorbell Project

The goal of this project is to design and build a doorbell detection circuit using an opto coupler to isolate the voltages and a raspberry pi to monitor the signal on its GPIO ports. The circuit is mounted on a breadboard and connected to the doorbell and the raspberry pi via short electrical leads. The opto coupler is used to isolate the voltages between the doorbell and the raspberry pi, ensuring that the raspberry pi is protected from any high voltage signals generated by the doorbell. The raspberry pi is programmed to monitor the signal on its GPIO ports and trigger a response when the doorbell is pressed. This circuit allows the raspberry pi to detect when the doorbell has been pressed and take appropriate action, such as sending a notification or activating a connected device.

## Inspiration & Design Phase

[Evin Jaff](https://evinjaff.github.io) designed the initial approach to this problem by finding the source of the signal sent from the original doorbell. In this case, that signal is sent using a DC voltage. Evin found the two wires that carry a differential voltage level from the push button to the control board which is located in a server closet.  The control board hast two wires which represent the voltage levels. When the button is pressed, the voltage across those two wires drops to zero. When the button is not pressed, the voltage level is at 16V (in this case).  By measuring the differential voltage across those two wires, we could detect when the button was pressed.  That was a key breakthrough--the ability to detect the push button event.  

Evin then put together a simple prototype circuit which proved that the signal was reliable, and that we could intercept the signal without having to alter or disable any of the existing functionality in the doorbell system. 

[Field Photo](https://github.com/kosar/howto/blob/main/breakout_wires.jpeg)

### Options: Raspberry Pi or the Arduino
There are a lot of ways to solve this problem, so we added one more constraint to make it a bit easier to find a path forward: we wanted to post a message on the network, which required us to use a network-enabled platform. Evin looked at using an Arduino, but once we realized that the network and internet connectivity would be required, we quickly pivoted to the Raspberry Pi which has a sophisticated linux-like stack and ample hardware around our household. 

## Design

The doorbell detection circuit consists of a few key components:

1. The opto coupler: This is a device that uses a light-emitting diode (LED) and a photosensitive transistor to isolate the voltages between two circuits. In this case, the LED will be connected to the doorbell circuit, and the transistor will be connected to the raspberry pi circuit. When the doorbell is pressed, the LED will emit a pulse of light, which will be detected by the transistor and trigger a signal on the raspberry pi circuit.

1. The raspberry pi: This is a small computer that can be programmed to perform a variety of tasks. In this case, the raspberry pi will be used to monitor the signal on its GPIO (general-purpose input/output) ports and trigger a response when the doorbell is pressed.

1. The breadboard: This is a device that allows easy building of prototype circuits by connecting components with jumper wires. The breadboard will be used to mount the opto coupler and the raspberry pi, as well as any other components that may be necessary, such as resistors or capacitors.

1. The electrical leads: These are short wires that will be used to connect the doorbell, the opto coupler, and the raspberry pi. The doorbell will be connected to the LED side of the opto coupler, and the raspberry pi will be connected to the transistor side.

To build the doorbell detection circuit, connect all of these components together on the breadboard using jumper wires. Once the circuit is assembled, program the raspberry pi to monitor the signal on its GPIO ports and trigger a response when the doorbell is pressed. This can be done using a variety of programming languages, such as Python or C++.

## Circuit

                +------------+
                |            |
                | Doorbell   |
                |            |
                +------------+
                      |
                      |
                | Voltage Drop |
                |  Resistors   |
                      |
                      V
                +------------+
                |            |
                | Opto coupler|
                |            |
                +------------+
                      |
                      |
                  | Resistor |
                      |
                      V
                +------------+
                |            |
                | Raspberry Pi|
                |            |
                +------------+

This circuit also requires two resistors in series between the doorbell and the opto coupler and also between the opto coupler and the raspberry pi.

### Voltage Divider Circuit
To design a circuit with resistors to drop a 16V line to 3.3V, we use a voltage divider circuit. A voltage divider circuit is a simple circuit that uses two resistors in series to divide the input voltage by a certain ratio. In this case the input voltage levels are about 16V (between the two wires connected to the push button at the doorbell).

Here is a diagram of a voltage divider circuit that can be used to drop a 16V line to 3.3V:

                              +------------+
                              |            |
                              | 16V line   |
                              |            |
                              +------------+
                                    |
                                    |
         R1 (10 k立)                 V
                                    |
                                    |
                                    V
                +------------+     R2 (10 k立)
                |            |
                | 3.3V line  |
                |            |
                +------------+

In this circuit, R1 and R2 are resistors that are placed in series with the 16V line. The value of these resistors will determine the ratio at which the input voltage is divided.

To calculate the resistor values, use the following formula:

$$R1 = R2 * \frac{Vout}{Vin - Vout}$$

where:

R1 and R2 are the resistor values (in ohms)
Vout is the output voltage (3.3V in this case)
Vin is the input voltage (16V in this case)
Plugging in the values from the example above, we get:

$$R1 = 10k\Omega * \frac{3.3V}{16V - 3.3V} = 10k\Omega * \frac{3.3V}{12.7V} = 10k\Omega * 0.262 = 2.62k\Omega$$

Therefore, the value of R1 should be approximately 2.62 k立.

To calculate the value of R2, we can use the same formula, but with R1 and R2 swapped:

$$R2 = R1 * \frac{Vin - Vout}{Vout}$$

Plugging in the values from the example above, we get:

$$R2 = 2.62k\Omega * \frac{16V - 3.3V}{3.3V} = 2.62k\Omega * \frac{12.7V}{3.3V} = 2.62k\Omega * 3.87 = 10.1k\Omega$$

Therefore, the value of R2 should be approximately 10.1 k立.


## Components

During build out of this circuit it is advantageous to use the opto coupler on a breadboard in order to experiment with the resistor values in the circuit, particularly so that the circuit does not inadvertently burn out the opto coupler chip. 

Individual Opto Couplers can be found as a packaged dual in line packaged chip (DIP Chip).

[DIP Chip - Compatible with Sharp PC817](https://www.amazon.com/gp/product/B08CXRHDHP/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&psc=1)

This opto coupler can also be packaged in a small pre-built circuit. 

[Integrated board with Opto Coupler and built-in resistors](https://www.amazon.com/gp/product/B07GMHLL2M/ref=ppx_yo_dt_b_asin_title_o01_s00?ie=UTF8&psc=1)

## Code

```
import RPi.GPIO as GPIO
import time

# Set up the GPIO pins
GPIO.setmode(GPIO.BCM)
GPIO.setup(17, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# Define the callback function
def doorbell_callback(channel):
  print("Doorbell was pressed!")
  # Insert code here to trigger a response (e.g. send a notification, activate a connected device)

# Set up an event detect on the doorbell pin
GPIO.add_event_detect(17, GPIO.FALLING, callback=doorbell_callback, bouncetime=200)

# Run the program in an infinite loop
while True:
  time.sleep(1)
```

The program first imports the necessary libraries (RPi.GPIO and time) and sets up the GPIO pins. It then defines a callback function that will be called whenever the doorbell is pressed. This function simply prints a message to the console; insert code here to trigger any desired response (e.g. send a notification, activate a connected device).

The program then sets up an event detect on the doorbell pin, using the add_event_detect function from the RPi.GPIO library. This function tells the raspberry pi to listen for a falling edge (a transition from high to low) on the specified pin, and to call the doorbell_callback function whenever it detects one. The bouncetime parameter specifies the minimum amount of time that must pass between successive calls to the callback function.

Finally, the program enters an infinite loop and waits for the doorbell to be pressed. When the doorbell is pressed, the event detect function triggers the callback function, which executes the desired response.


## Testing

The existing telephone system uses the Channel Vision TE 200 circuit board ([manual here](https://jmacfiles.s3.amazonaws.com/TE200II.pdf)).

## References / Articles Consulted Prior To This Design
There are many articles on the internet about coupling electrical circuits like this one. 

[This one](https://www.instructables.com/Isolating-circuits-from-your-arduino-with-optocoup/) talks about doing this on an Arduino board, a common micro controller based solution. It is important to see how the circuit is designed from this article, even if the actual controller is not the Arduino (e.g., a Pi). 

[This article from Raspberry Pi Forums](https://forums.raspberrypi.com/viewtopic.php?t=220127) has a good set of ideas and prior art. The simplest example is in the threaded comments [by 'rpdom'](https://forums.raspberrypi.com/viewtopic.php?t=220127#p1351502) where they specify the same circuit (essentially) as this one.

### Here is what ChatGPT gives us as articles for further background:

1. [Optocoupler Basics: How to Use an Optocoupler with an Arduino](https://www.arduino-tutorials.com/opto-couplers/optocoupler-basics-how-to-use-an-optocoupler-with-an-arduino/)
2. [How to Use an Optocoupler with a Raspberry Pi](https://www.raspberrypi.org/documentation/usage/gpio/optocouplers.md)
3. [Opto-Isolators: How to Use an Optocoupler in Your Circuit](https://www.electronics-tutorials.ws/opto/opto.html)
